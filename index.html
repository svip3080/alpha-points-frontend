<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Alpha 积分管理日历</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .accounts-overview {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .accounts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .accounts-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .account-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .account-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .account-card.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .account-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .account-card.green {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .account-card.orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .account-card.purple {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .account-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .account-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            opacity: 0.9;
        }

        .account-total {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .account-change {
            font-size: 12px;
            text-align: center;
            opacity: 0.8;
        }

        .current-account-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .current-account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .current-account-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-year {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .nav-btn:hover {
            background: #5a6fd8;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 20px;
        }

        .day-header {
            background: #f8f9fa;
            padding: 15px 5px;
            text-align: center;
            font-weight: bold;
            color: #666;
            border-radius: 8px;
        }

        .day-cell {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 5px;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .day-cell:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .day-cell.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .day-cell.other-month {
            opacity: 0.3;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .points-change {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin: 1px 0;
        }

        .points-positive {
            background: #d4edda;
            color: #155724;
        }

        .points-negative {
            background: #f8d7da;
            color: #721c24;
        }

        .points-neutral {
            background: #e2e3e5;
            color: #383d41;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .btn.success {
            background: #28a745;
        }

        .btn.success:hover {
            background: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            color: #2c3e50;
        }

        .dashboard {
            display: none;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .account-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="loginContainer" class="login-container">
        <h2 class="login-title">Binance Alpha 积分管理</h2>
        <div class="form-group">
            <label>用户名</label>
            <input type="text" id="username" placeholder="请输入用户名">
        </div>
        <div class="form-group">
            <label>密码</label>
            <input type="password" id="password" placeholder="请输入密码">
        </div>
        <button class="btn" onclick="login()" style="width: 100%;">登录</button>
        <p style="text-align: center; margin-top: 15px; color: #666;">
        </p>
    </div>

    <!-- 主界面 -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <div class="header">
                <div class="title">Binance Alpha 积分管理日历</div>
                <div class="user-info">
                    <span>欢迎，<strong id="currentUser">用户</strong></span>
                    <button class="btn secondary" id="adminBtn" onclick="showAdminPanel()" style="display: none; margin-right: 10px;">管理员面板</button>
                    <button class="logout-btn" onclick="logout()">退出</button>
                </div>
            </div>

            <!-- 总览面板 -->
            <div class="accounts-overview">
                <div class="accounts-header">
                    <div class="accounts-title">我的Alpha账户总览</div>
                    <button class="btn success" onclick="openAddAccountModal()">+ 添加账户</button>
                </div>
                
                <div class="account-summary">
                    <div class="summary-card">
                        <div class="summary-title">总账户数</div>
                        <div class="summary-value" id="totalAccounts">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">总积分</div>
                        <div class="summary-value" id="totalAllPoints">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">今日变化</div>
                        <div class="summary-value" id="todayChange">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">平均积分</div>
                        <div class="summary-value" id="avgPoints">0</div>
                    </div>
                </div>

                <div class="accounts-grid" id="accountsGrid">
                    <!-- 账户卡片将通过 JavaScript 生成 -->
                </div>
            </div>

            <!-- 当前选中账户详情 -->
            <div class="current-account-panel">
                <div class="current-account-header">
                    <div class="current-account-name" id="currentAccountName">请选择一个账户</div>
                    <div class="actions">
                        <button class="btn" onclick="openAddPointsModal()">添加积分记录</button>
                        <button class="btn secondary" onclick="exportAccountData()">导出当前账户</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-value" id="currentAccountTotal">0</div>
                        <div class="stat-label">当前总积分</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-value" id="currentAccountMonthly">0</div>
                        <div class="stat-label">本月积分</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-value" id="currentAccountWeekly">0</div>
                        <div class="stat-label">本周积分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentAccountRolling">0</div>
                        <div class="stat-label">15天滚动积分</div>
                    </div>
                </div>
            </div>

            <!-- 日历 -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="nav-btn" onclick="previousMonth()">‹ 上月</button>
                    <div class="month-year" id="monthYear">2025年9月</div>
                    <button class="nav-btn" onclick="nextMonth()">下月 ›</button>
                </div>
                <div class="calendar" id="calendar">
                    <!-- 日历将通过 JavaScript 生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 添加账户模态框 -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addAccountModal')">&times;</span>
            <h3 style="margin-bottom: 20px;">添加新的Alpha账户</h3>
            <div class="form-group">
                <label>账户名称</label>
                <input type="text" id="newAccountName" placeholder="例如：主账户、小号1、备用账户等">
            </div>
            <div class="form-group">
                <label>账户描述（可选）</label>
                <textarea id="newAccountDesc" placeholder="描述这个账户的用途" rows="3"></textarea>
            </div>
            <button class="btn" onclick="addNewAccount()">添加账户</button>
        </div>
    </div>

    <!-- 添加积分记录模态框 -->
    <div id="pointsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('pointsModal')">&times;</span>
            <h3 style="margin-bottom: 20px;">添加积分记录</h3>
            <div class="form-group">
                <label>账户</label>
                <select id="pointsAccount">
                    <!-- 账户选项将通过 JavaScript 生成 -->
                </select>
            </div>
            <div class="form-group">
                <label>日期</label>
                <input type="date" id="pointsDate">
            </div>
            <div class="form-group">
                <label>积分类型</label>
                <select id="pointsType">
                    <option value="balance">余额积分</option>
                    <option value="trading">交易积分</option>
                    <option value="airdrop">空投扣分</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <div class="form-group">
                <label>积分变化</label>
                <input type="number" id="pointsChange" placeholder="正数为增加，负数为减少">
            </div>
            <div class="form-group">
                <label>备注</label>
                <textarea id="pointsNote" placeholder="可选：添加备注说明" rows="3"></textarea>
            </div>
            <button class="btn" onclick="savePoints()">保存</button>
        </div>
    </div>

    <!-- 管理员面板 -->
    <div id="adminPanel" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('adminPanel')">&times;</span>
            <h3 style="margin-bottom: 20px;">管理员面板</h3>
            
            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">系统统计</h4>
                <div class="account-summary">
                    <div class="summary-card">
                        <div class="summary-title">总用户数</div>
                        <div class="summary-value" id="adminTotalUsers">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">总账户数</div>
                        <div class="summary-value" id="adminTotalAccounts">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">总积分记录</div>
                        <div class="summary-value" id="adminTotalRecords">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">活跃用户</div>
                        <div class="summary-value" id="adminActiveUsers">0</div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">数据导出</h4>
                <div class="actions">
                    <button class="btn" onclick="exportAllUsersData()">导出所有用户数据</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API配置
        const API_BASE_URL = 'https://150.109.79.28/api';
        
        // 全局变量
        let currentUser = null;
        let currentAccount = null;
        let userAccounts = [];
        let pointsData = {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let authToken = localStorage.getItem('authToken');

        // API请求函数
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '请求失败');
                }

                return data;
            } catch (error) {
                console.error('API请求错误:', error);
                if (error.message.includes('需要登录')) {
                    logout();
                }
                throw error;
            }
        }

        // 账户卡片颜色
        const cardColors = ['blue', 'green', 'orange', 'purple', '', 'blue', 'green', 'orange', 'purple', ''];

        // 登录功能
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('请输入用户名和密码');
                return;
            }

            try {
                const data = await apiRequest('/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });

                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                currentUser = data.user;

                document.getElementById('currentUser').textContent = currentUser.name;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // 显示管理员按钮（如果是管理员）
                if (currentUser.role === 'admin') {
                    document.getElementById('adminBtn').style.display = 'inline-block';
                }
                
                await loadUserData();
                generateAccountsGrid();
                updateOverallStats();
                generateCalendar();
            } catch (error) {
                alert('登录失败: ' + error.message);
            }
        }

        function logout() {
            currentUser = null;
            currentAccount = null;
            authToken = null;
            userAccounts = [];
            pointsData = {};
            localStorage.removeItem('authToken');
            
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('adminBtn').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // 加载用户数据
        async function loadUserData() {
            try {
                userAccounts = await apiRequest('/accounts');
                
                pointsData = {};
                for (const account of userAccounts) {
                    const records = await apiRequest(`/points?accountId=${account.accountId}`);
                    pointsData[account.accountId] = {};
                    
                    records.forEach(record => {
                        if (!pointsData[account.accountId][record.date]) {
                            pointsData[account.accountId][record.date] = [];
                        }
                        pointsData[account.accountId][record.date].push(record);
                    });
                }
            } catch (error) {
                console.error('加载用户数据失败:', error);
                alert('加载数据失败: ' + error.message);
            }
        }

        // 生成账户网格
        function generateAccountsGrid() {
            const grid = document.getElementById('accountsGrid');
            grid.innerHTML = '';

            userAccounts.forEach((account, index) => {
                const card = document.createElement('div');
                card.className = `account-card ${cardColors[index % cardColors.length]}`;
                if (currentAccount === account.accountId) {
                    card.classList.add('active');
                }

                const totalPoints = calculateAccountTotal(account.accountId);
                const todayChange = calculateTodayChange(account.accountId);

                card.innerHTML = `
                    <div class="account-name">${account.name}</div>
                    <div class="account-total">${totalPoints}</div>
                    <div class="account-change">今日: ${todayChange >= 0 ? '+' : ''}${todayChange}</div>
                    <div class="account-stats">
                        <span>15天: ${calculateRollingPoints(account.accountId)}</span>
                        <span>本月: ${calculateMonthlyPoints(account.accountId)}</span>
                    </div>
                `;

                card.onclick = () => selectAccount(account.accountId);
                grid.appendChild(card);
            });

            updatePointsAccountOptions();
        }

        // 选择账户
        function selectAccount(accountId) {
            currentAccount = accountId;
            const account = userAccounts.find(acc => acc.accountId === accountId);
            
            document.getElementById('currentAccountName').textContent = account.name;
            
            generateAccountsGrid();
            updateCurrentAccountStats();
            generateCalendar();
        }

        // 计算相关函数
        function calculateAccountTotal(accountId) {
            let total = 0;
            if (!pointsData[accountId]) return total;

            Object.keys(pointsData[accountId]).forEach(dateKey => {
                const records = pointsData[accountId][dateKey];
                records.forEach(record => {
                    total += record.change;
                });
            });
            return total;
        }

        function calculateTodayChange(accountId) {
            const today = new Date().toISOString().split('T')[0];
            let change = 0;
            
            if (pointsData[accountId] && pointsData[accountId][today]) {
                pointsData[accountId][today].forEach(record => {
                    change += record.change;
                });
            }
            return change;
        }

        function calculateRollingPoints(accountId) {
            const now = new Date();
            const fifteenDaysAgo = new Date(now - 15 * 24 * 60 * 60 * 1000);
            let total = 0;

            if (!pointsData[accountId]) return total;

            Object.keys(pointsData[accountId]).forEach(dateKey => {
                const recordDate = new Date(dateKey);
                if (recordDate >= fifteenDaysAgo) {
                    const records = pointsData[accountId][dateKey];
                    records.forEach(record => {
                        total += record.change;
                    });
                }
            });
            return total;
        }

        function calculateMonthlyPoints(accountId) {
            let total = 0;
            if (!pointsData[accountId]) return total;

            Object.keys(pointsData[accountId]).forEach(dateKey => {
                const recordDate = new Date(dateKey);
                if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                    const records = pointsData[accountId][dateKey];
                    records.forEach(record => {
                        total += record.change;
                    });
                }
            });
            return total;
        }

        // 更新总览统计
        function updateOverallStats() {
            const totalAccounts = userAccounts.length;
            let totalAllPoints = 0;
            let todayChange = 0;

            userAccounts.forEach(account => {
                totalAllPoints += calculateAccountTotal(account.accountId);
                todayChange += calculateTodayChange(account.accountId);
            });

            const avgPoints = totalAccounts > 0 ? Math.round(totalAllPoints / totalAccounts) : 0;

            document.getElementById('totalAccounts').textContent = totalAccounts;
            document.getElementById('totalAllPoints').textContent = totalAllPoints;
            document.getElementById('todayChange').textContent = todayChange >= 0 ? '+' + todayChange : todayChange;
            document.getElementById('avgPoints').textContent = avgPoints;
        }

        // 更新当前账户统计
        function updateCurrentAccountStats() {
            if (!currentAccount) {
                document.getElementById('currentAccountTotal').textContent = '0';
                document.getElementById('currentAccountMonthly').textContent = '0';
                document.getElementById('currentAccountWeekly').textContent = '0';
                document.getElementById('currentAccountRolling').textContent = '0';
                return;
            }

            const total = calculateAccountTotal(currentAccount);
            const monthly = calculateMonthlyPoints(currentAccount);
            const weekly = calculateWeeklyPoints(currentAccount);
            const rolling = calculateRollingPoints(currentAccount);

            document.getElementById('currentAccountTotal').textContent = total;
            document.getElementById('currentAccountMonthly').textContent = monthly;
            document.getElementById('currentAccountWeekly').textContent = weekly;
            document.getElementById('currentAccountRolling').textContent = rolling;
        }

        // 添加新账户
        function openAddAccountModal() {
            document.getElementById('addAccountModal').style.display = 'block';
        }

        async function addNewAccount() {
            const name = document.getElementById('newAccountName').value.trim();
            const description = document.getElementById('newAccountDesc').value.trim();

            if (!name) {
                alert('请输入账户名称');
                return;
            }

            try {
                const accountId = 'account_' + Date.now();
                await apiRequest('/accounts', {
                    method: 'POST',
                    body: JSON.stringify({ accountId, name, description })
                });

                document.getElementById('newAccountName').value = '';
                document.getElementById('newAccountDesc').value = '';
                
                closeModal('addAccountModal');
                await loadUserData();
                generateAccountsGrid();
                updateOverallStats();
            } catch (error) {
                alert('添加账户失败: ' + error.message);
            }
        }

        // 更新积分记录模态框的账户选项
        function updatePointsAccountOptions() {
            const select = document.getElementById('pointsAccount');
            select.innerHTML = '';

            userAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.accountId;
                option.textContent = account.name;
                if (account.accountId === currentAccount) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // 生成日历
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('monthYear');
            
            calendar.innerHTML = '';
            
            const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            monthYear.textContent = `${currentYear}年${months[currentMonth]}`;

            const dayHeaders = ['日', '一', '二', '三', '四', '五', '六'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();

            for (let i = 0; i < firstDay; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell other-month';
                calendar.appendChild(dayCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                if (currentYear === today.getFullYear() && 
                    currentMonth === today.getMonth() && 
                    day === today.getDate()) {
                    dayCell.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (currentAccount && 
                    pointsData[currentAccount] && 
                    pointsData[currentAccount][dateKey]) {
                    const records = pointsData[currentAccount][dateKey];
                    records.forEach(record => {
                        const pointsDiv = document.createElement('div');
                        pointsDiv.className = `points-change ${record.change > 0 ? 'points-positive' : record.change < 0 ? 'points-negative' : 'points-neutral'}`;
                        pointsDiv.textContent = `${record.change > 0 ? '+' : ''}${record.change}`;
                        dayCell.appendChild(pointsDiv);
                    });
                }

                dayCell.onclick = () => openDayDetail(dateKey);
                calendar.appendChild(dayCell);
            }
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
            updateCurrentAccountStats();
            updateOverallStats();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar();
            updateCurrentAccountStats();
            updateOverallStats();
        }

        function openDayDetail(dateKey) {
            if (!currentAccount) {
                alert('请先选择一个账户');
                return;
            }
            document.getElementById('pointsDate').value = dateKey;
            document.getElementById('pointsAccount').value = currentAccount;
            openAddPointsModal();
        }

        function openAddPointsModal() {
            if (userAccounts.length === 0) {
                alert('请先添加一个账户');
                return;
            }
            
            if (!document.getElementById('pointsDate').value) {
                document.getElementById('pointsDate').value = new Date().toISOString().split('T')[0];
            }
            
            updatePointsAccountOptions();
            document.getElementById('pointsModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function savePoints() {
            const accountId = document.getElementById('pointsAccount').value;
            const date = document.getElementById('pointsDate').value;
            const type = document.getElementById('pointsType').value;
            const change = parseInt(document.getElementById('pointsChange').value);
            const note = document.getElementById('pointsNote').value;

            if (!accountId || !date || isNaN(change)) {
                alert('请填写完整信息');
                return;
            }

            try {
                await apiRequest('/points', {
                    method: 'POST',
                    body: JSON.stringify({ accountId, date, type, change, note })
                });

                document.getElementById('pointsType').value = 'balance';
                document.getElementById('pointsChange').value = '';
                document.getElementById('pointsNote').value = '';

                closeModal('pointsModal');
                await loadUserData();
                generateAccountsGrid();
                updateOverallStats();
                updateCurrentAccountStats();
                generateCalendar();
            } catch (error) {
                alert('保存积分失败: ' + error.message);
            }
        }

        function exportAccountData() {
            if (!currentAccount) {
                alert('请先选择一个账户');
                return;
            }

            const account = userAccounts.find(acc => acc.accountId === currentAccount);
            const data = {
                account: account,
                points: pointsData[currentAccount] || {}
            };

            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${account.name}_points_data.json`;
            a.click();
        }

        // 管理员功能
        async function showAdminPanel() {
            if (currentUser.role !== 'admin') {
                alert('无权限访问');
                return;
            }
            
            try {
                const stats = await apiRequest('/admin/stats');
                document.getElementById('adminTotalUsers').textContent = stats.totalUsers;
                document.getElementById('adminTotalAccounts').textContent = stats.totalAccounts;
                document.getElementById('adminTotalRecords').textContent = stats.totalRecords;
                document.getElementById('adminActiveUsers').textContent = stats.activeUsers;
                
                document.getElementById('adminPanel').style.display = 'block';
            } catch (error) {
                alert('加载管理员数据失败: ' + error.message);
            }
        }

        async function exportAllUsersData() {
            try {
                const data = await apiRequest('/admin/export-all');
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'all_users_data.json';
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('导出数据失败: ' + error.message);
            }
        }

        // 页面加载时检查登录状态
        window.onload = function() {
            if (authToken) {
                // 可以添加token验证逻辑
            }
        };
    </script>
</body>
</html>
